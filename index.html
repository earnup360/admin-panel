<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Withdrawal Requests</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1c1e21; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .status-pending { color: orange; font-weight: bold; }
        .status-paid { color: green; font-weight: bold; }
        .status-rejected { color: red; font-weight: bold; }
        .actions button { padding: 6px 10px; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-paid { background-color: #28a745; }
        .btn-reject { background-color: #dc3545; }
        #access-denied { text-align: center; font-size: 1.5em; color: red; padding: 50px; }
        .filter-nav { text-align: center; margin-bottom: 20px; }
        .filter-nav button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; background: #fff; margin: 0 5px; }
        .filter-nav button.active { background: #4CAF50; color: white; border-color: #4CAF50; }
    </style>
</head>
<body>

    <div id="admin-container" style="display: none;">
        <div class="container">
            <h1>Withdrawal Requests</h1>
            <div class="filter-nav">
                <button id="filter-pending" class="active">Pending</button>
                <button id="filter-paid">Paid</button>
                <button id="filter-rejected">Rejected</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>User Name</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="requests-table">
                    </tbody>
            </table>
        </div>
    </div>
    <div id="access-denied" style="display: none;">
        <h2>ACCESS DENIED</h2>
        <p>You are not authorized to view this page.</p>
    </div>

    <script>
        // --- Configuration ---
        const ADMIN_TELEGRAM_ID = 7851054198; // আপনার টেলিগ্রাম ইউজার আইডি এখানে দিন

        // আপনার Firebase প্রজেক্টের একই কনফিগারেশন এখানেও দিন
        const firebaseConfig = {
            apiKey: "AIzaSy...YOUR_API_KEY",
            authDomain: "your-project-id.firebaseapp.com",
            databaseURL: "https://your-project-id.firebaseio.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "1:YOUR:APP:ID"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const tg = window.Telegram.WebApp;

        let currentFilter = 'pending';

        // --- Initialization and Auth Check ---
        window.onload = function() {
            tg.ready();

            if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id === ADMIN_TELEGRAM_ID) {
                // Admin is verified
                document.getElementById('admin-container').style.display = 'block';
                loadRequests();
                setupFilters();
            } else {
                // Not an admin
                document.getElementById('access-denied').style.display = 'block';
            }
        };

        function setupFilters() {
            const filters = document.querySelectorAll('.filter-nav button');
            filters.forEach(button => {
                button.addEventListener('click', () => {
                    filters.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentFilter = button.id.split('-')[1]; // e.g., 'pending'
                    loadRequests();
                });
            });
        }
        
        // --- Firebase Data Loading ---
        function loadRequests() {
            const requestsRef = database.ref('withdrawRequests').orderByChild('status').equalTo(currentFilter);
            const tableBody = document.getElementById('requests-table');
            
            requestsRef.on('value', (snapshot) => {
                tableBody.innerHTML = ''; // Clear previous data
                if (!snapshot.exists()) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No ${currentFilter} requests found.</td></tr>`;
                    return;
                }
                snapshot.forEach((childSnapshot) => {
                    const requestId = childSnapshot.key;
                    const requestData = childSnapshot.val();
                    
                    const row = document.createElement('tr');
                    const formattedDate = new Date(requestData.timestamp).toLocaleString();
                    
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${requestData.userName} (ID: ${requestData.userId})</td>
                        <td>${requestData.amount} Taka</td>
                        <td>${requestData.method.toUpperCase()}</td>
                        <td>${requestData.phone}</td>
                        <td><span class="status-${requestData.status}">${requestData.status}</span></td>
                        <td class="actions">
                            ${requestData.status === 'pending' ? `
                            <button class="btn-paid" onclick="updateStatus('${requestId}', 'paid')">Mark Paid</button>
                            <button class="btn-reject" onclick="rejectRequest('${requestId}', '${requestData.userId}', ${requestData.amount})">Reject</button>
                            ` : 'Completed'}
                        </td>
                    `;
                    tableBody.prepend(row); // নতুন রিকোয়েস্ট উপরে দেখানোর জন্য
                });
            });
        }
        
        // --- Actions ---
        function updateStatus(requestId, newStatus) {
            if (confirm(`Are you sure you want to mark this request as ${newStatus}?`)) {
                const requestRef = database.ref(`withdrawRequests/${requestId}/status`);
                requestRef.set(newStatus)
                    .then(() => alert('Status updated successfully!'))
                    .catch(err => alert('Error updating status: ' + err.message));
            }
        }

        function rejectRequest(requestId, userId, amount) {
             if (confirm(`Are you sure you want to REJECT this request and REFUND ${amount} Taka to the user?`)) {
                const userBalanceRef = database.ref(`users/${userId}/balance`);
                // Use transaction to safely refund the money
                userBalanceRef.transaction((currentBalance) => {
                    return (currentBalance || 0) + amount;
                }).then(() => {
                    // After successful refund, update the request status to 'rejected'
                    const requestStatusRef = database.ref(`withdrawRequests/${requestId}/status`);
                    return requestStatusRef.set('rejected');
                }).then(() => {
                    alert('Request rejected and amount refunded successfully!');
                }).catch(err => {
                    alert('An error occurred during rejection: ' + err.message);
                });
            }
        }
    </script>
</body>
</html>
